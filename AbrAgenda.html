<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Digital - Modern & Clean</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest_agenda.json">
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Quill Editor CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff;
            color: #1f2937;
        }

        /* Green gradient buttons */
        .green-gradient {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transition: all 0.3s ease;
        }

        .green-gradient:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(5, 150, 105, 0.3);
        }

        .green-gradient:active {
            transform: translateY(0);
        }

        /* Tab styles */
        .tab-active {
            border-bottom: 3px solid #10b981;
            color: #10b981;
            font-weight: 600;
        }

        .tab-item {
            transition: all 0.3s ease;
        }

        .tab-item:hover {
            background-color: #f3f4f6;
        }

        /* Task card styles */
        .task-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .priority-high {
            border-left-color: #ef4444;
        }

        .priority-medium {
            border-left-color: #f59e0b;
        }

        .priority-low {
            border-left-color: #10b981;
        }

        .completed {
            opacity: 0.6;
        }

        .completed .task-title {
            text-decoration: line-through;
            color: #6b7280;
        }

        /* Modal styles */
        .modal-enter {
            animation: modalEnter 0.3s ease-out;
        }

        @keyframes modalEnter {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Icon button styles */
        .icon-btn {
            transition: all 0.2s ease;
        }

        .icon-btn:hover {
            transform: scale(1.1);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #10b981;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #059669;
        }

        /* Badge styles */
        .badge-green {
            background-color: #d1fae5;
            color: #065f46;
        }

        .badge-yellow {
            background-color: #fef3c7;
            color: #92400e;
        }

        .badge-red {
            background-color: #fee2e2;
            color: #991b1b;
        }

        /* Fade in animation */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Category label style */
        .category-label {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 14px;
            color: #6b7280;
            background-color: #f9fafb;
            padding: 4px 8px;
            border-radius: 4px;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #10b981;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Task content display */
        .task-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
        }

        .task-content.collapsed {
            max-height: 4.8em;
            /* 3 lines of text */
            overflow: hidden;
            position: relative;
        }

        .task-content.collapsed::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 1.2em;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 1));
        }

        .expand-btn {
            color: #10b981;
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: 0.5rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            transition: all 0.2s ease;
        }

        .expand-btn:hover {
            color: #059669;
        }

        .expand-btn i {
            margin-left: 0.25rem;
            transition: transform 0.2s ease;
        }

        .expand-btn.expanded i {
            transform: rotate(180deg);
        }

        /* Quill Editor Styles */
        #editor-container {
            min-height: 150px;
            margin-bottom: 15px;
        }

        .ql-toolbar {
            border-top: 1px solid #e2e8f0;
            border-left: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
            border-bottom: none;
            border-radius: 0.5rem 0.5rem 0 0;
            background-color: #f9fafb;
        }

        .ql-container {
            border-bottom: 1px solid #e2e8f0;
            border-left: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            font-size: 16px;
        }

        .ql-editor {
            min-height: 120px;
            font-family: inherit;
        }

        .ql-editor:focus {
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
    </style>
</head>

<body class="min-h-screen">
    <!-- Token Modal -->
    <div id="tokenModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md modal-enter">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Token GitHub</h2>
                    <button id="closeTokenModal" class="text-gray-400 hover:text-gray-600 transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Masukkan token GitHub Anda</label>
                    <input type="password" id="tokenInput"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        placeholder="ghp_...">
                </div>

                <div class="mb-4 text-sm text-gray-600">
                    <p>Token diperlukan untuk mengakses data Anda di GitHub.</p>
                    <p class="mt-1">Anda bisa membuat token di: <a href="https://github.com/settings/tokens"
                            target="_blank" class="text-green-600 hover:underline">github.com/settings/tokens</a></p>
                </div>

                <div class="flex justify-between items-center mb-4">
                    <button id="resetTokenBtn" class="text-red-500 hover:text-red-700 text-sm">
                        <i class="fas fa-redo mr-1"></i>Reset Token
                    </button>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" id="tokenBatal"
                        class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        Batal
                    </button>
                    <button type="button" id="tokenSimpan"
                        class="green-gradient text-white px-6 py-2 rounded-lg font-medium">
                        Simpan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 flex flex-col items-center">
            <div class="spinner mb-4"></div>
            <p class="text-gray-700">Memuat data...</p>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md modal-enter">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <div class="bg-red-100 p-3 rounded-full mr-4">
                        <i class="fas fa-exclamation-circle text-red-500 text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Kesalahan</h2>
                        <p id="errorMessage" class="text-gray-600 mt-1">Terjadi kesalahan saat memuat data</p>
                    </div>
                </div>

                <div class="mt-6">
                    <button id="errorModalClose"
                        class="w-full green-gradient text-white px-6 py-2 rounded-lg font-medium">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="mb-8">
            <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">
                            <i class="fas fa-calendar-check text-green-600 mr-3"></i>
                            Agenda
                        </h1>
                    </div>
                    <div class="flex space-x-3">
                        <button id="exportBtn"
                            class="bg-white border border-green-500 text-green-600 px-5 py-2.5 rounded-lg hover:bg-green-50 transition flex items-center">
                            <i class="fas fa-file-pdf mr-2"></i>
                        </button>
                        <button id="toggleCompletedBtn"
                            class="bg-white border border-green-500 text-green-600 px-5 py-2.5 rounded-lg hover:bg-green-50 transition flex items-center">
                            <i class="fas fa-eye-slash mr-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tab Management -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border border-gray-100">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Kategori</h2>
                <button id="addTabBtn" class="green-gradient text-white px-4 py-2 rounded-lg flex items-center">
                    <i class="fas fa-plus mr-2"></i>Tambah Tab
                </button>
            </div>

            <div class="flex space-x-1 overflow-x-auto pb-2" id="tabContainer">
                <!-- Tabs will be dynamically added here -->
            </div>
        </div>

        <!-- Task List -->
        <div id="taskList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Tasks will be dynamically inserted here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-16 hidden">
            <div class="bg-white rounded-2xl shadow-lg p-8 border border-gray-100">
                <i class="fas fa-clipboard-list text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Belum ada tugas</h3>
                <p class="text-gray-500">Klik "Tambah Tugas Baru" untuk memulai!</p>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl modal-enter">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="modalTitle" class="text-2xl font-bold text-gray-800">Tambah Tugas Baru</h2>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <form id="taskForm">
                    <div class="mb-4 relative">
                        <label class="block text-gray-700 font-medium mb-2">Judul Tugas</label>
                        <div id="editor-container"></div>
                        <input type="hidden" id="taskTitle" required>
                        <div id="categoryLabel" class="category-label hidden"></div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-2">Prioritas</label>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="priority" value="low" class="mr-2">
                                <span class="text-green-600">Rendah</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="priority" value="medium" class="mr-2" checked>
                                <span class="text-yellow-600">Sedang</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="priority" value="high" class="mr-2">
                                <span class="text-red-600">Tinggi</span>
                            </label>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancelBtn"
                            class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                            Batal
                        </button>
                        <button type="submit" class="green-gradient text-white px-6 py-2 rounded-lg font-medium">
                            Simpan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tab Edit Modal -->
    <div id="tabModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md modal-enter">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Edit Kategori</h2>
                    <button id="closeTabModal" class="text-gray-400 hover:text-gray-600 transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <form id="tabForm">
                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-2">Nama Kategori</label>
                        <input type="text" id="tabName" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-2">Icon</label>
                        <div class="grid grid-cols-4 gap-2">
                            <button type="button" class="icon-option p-3 border rounded-lg hover:bg-green-50"
                                data-icon="fa-briefcase">
                                <i class="fas fa-briefcase text-green-600"></i>
                            </button>
                            <button type="button" class="icon-option p-3 border rounded-lg hover:bg-green-50"
                                data-icon="fa-user">
                                <i class="fas fa-user text-green-600"></i>
                            </button>
                            <button type="button" class="icon-option p-3 border rounded-lg hover:bg-green-50"
                                data-icon="fa-book">
                                <i class="fas fa-book text-green-600"></i>
                            </button>
                            <button type="button" class="icon-option p-3 border rounded-lg hover:bg-green-50"
                                data-icon="fa-heartbeat">
                                <i class="fas fa-heartbeat text-green-600"></i>
                            </button>
                            <button type="button" class="icon-option p-3 border rounded-lg hover:bg-green-50"
                                data-icon="fa-home">
                                <i class="fas fa-home text-green-600"></i>
                            </button>
                            <button type="button" class="icon-option p-3 border rounded-lg hover:bg-green-50"
                                data-icon="fa-shopping-cart">
                                <i class="fas fa-shopping-cart text-green-600"></i>
                            </button>
                            <button type="button" class="icon-option p-3 border rounded-lg hover:bg-green-50"
                                data-icon="fa-plane">
                                <i class="fas fa-plane text-green-600"></i>
                            </button>
                            <button type="button" class="icon-option p-3 border rounded-lg hover:bg-green-50"
                                data-icon="fa-star">
                                <i class="fas fa-star text-green-600"></i>
                            </button>
                        </div>
                        <input type="hidden" id="tabIcon" value="fa-tasks">
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancelTabBtn"
                            class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                            Batal
                        </button>
                        <button type="submit" class="green-gradient text-white px-6 py-2 rounded-lg font-medium">
                            Simpan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Task Button -->
    <button id="addTaskBtn"
        class="fixed bottom-8 right-8 green-gradient text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center icon-btn">
        <i class="fas fa-plus text-xl"></i>
    </button>

    <script>
        // GitHub API Configuration
        const GITHUB_API_URL = "https://api.github.com/repos/idarohpusat-blip/my_rep/contents/database_agenda.json";
        const TOKEN_KEY = "agenda_github_token";
        let githubToken = null;
        let dataLoaded = false;
        let connectionRetries = 0;
        const MAX_RETRIES = 3;

        // Data Management
        let tasks = [];
        let tabs = [
            { id: 'all', name: 'Semua', icon: 'fa-list' },
            { id: 'work', name: 'Kerja', icon: 'fa-briefcase' },
            { id: 'personal', name: 'Pribadi', icon: 'fa-user' },
            { id: 'study', name: 'Belajar', icon: 'fa-book' },
            { id: 'health', name: 'Kesehatan', icon: 'fa-heartbeat' }
        ];
        let currentTab = 'all';
        let showCompleted = false;
        let editingTabId = null;
        let editingTaskId = null;
        let quill = null;

        // DOM Elements
        const taskList = document.getElementById('taskList');
        const emptyState = document.getElementById('emptyState');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const taskModal = document.getElementById('taskModal');
        const tabModal = document.getElementById('tabModal');
        const closeModal = document.getElementById('closeModal');
        const closeTabModal = document.getElementById('closeTabModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const cancelTabBtn = document.getElementById('cancelTabBtn');
        const taskForm = document.getElementById('taskForm');
        const tabForm = document.getElementById('tabForm');
        const exportBtn = document.getElementById('exportBtn');
        const toggleCompletedBtn = document.getElementById('toggleCompletedBtn');
        const addTabBtnEl = document.getElementById('addTabBtn');
        const tabContainer = document.getElementById('tabContainer');
        const categoryLabel = document.getElementById('categoryLabel');
        const modalTitle = document.getElementById('modalTitle');
        const tokenModal = document.getElementById('tokenModal');
        const closeTokenModal = document.getElementById('closeTokenModal');
        const tokenInput = document.getElementById('tokenInput');
        const tokenSimpan = document.getElementById('tokenSimpan');
        const tokenBatal = document.getElementById('tokenBatal');
        const resetTokenBtn = document.getElementById('resetTokenBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorModal = document.getElementById('errorModal');
        const errorMessage = document.getElementById('errorMessage');
        const errorModalClose = document.getElementById('errorModalClose');

        // Event Listeners
        addTaskBtn.addEventListener('click', () => openTaskModal());
        closeModal.addEventListener('click', () => closeTaskModal());
        closeTabModal.addEventListener('click', () => closeTabModalHandler());
        cancelBtn.addEventListener('click', () => closeTaskModal());
        cancelTabBtn.addEventListener('click', () => closeTabModalHandler());
        taskForm.addEventListener('submit', handleTaskSubmit);
        tabForm.addEventListener('submit', handleTabSubmit);
        exportBtn.addEventListener('click', exportToPDF);
        toggleCompletedBtn.addEventListener('click', toggleCompleted);
        addTabBtnEl.addEventListener('click', () => openTabModal());

        // Token Modal Event Listeners
        closeTokenModal.addEventListener('click', () => {
            tokenModal.classList.add('hidden');
        });
        tokenBatal.addEventListener('click', () => {
            tokenModal.classList.add('hidden');
        });
        tokenSimpan.addEventListener('click', saveToken);
        resetTokenBtn.addEventListener('click', resetToken);
        errorModalClose.addEventListener('click', () => {
            errorModal.classList.add('hidden');
        });

        // Icon selection
        document.querySelectorAll('.icon-option').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.icon-option').forEach(b => b.classList.remove('bg-green-100'));
                btn.classList.add('bg-green-100');
                document.getElementById('tabIcon').value = btn.dataset.icon;
            });
        });

        // GitHub API Functions
        async function loadGithubToken() {
            const savedToken = localStorage.getItem(TOKEN_KEY);
            if (savedToken) {
                githubToken = savedToken;
                return true;
            }

            // Show token modal
            tokenModal.classList.remove('hidden');
            tokenModal.classList.add('flex');
            return new Promise((resolve) => {
                tokenSimpan.onclick = () => {
                    const token = tokenInput.value.trim();
                    if (token) {
                        saveToken();
                        resolve(true);
                    }
                };
                tokenBatal.onclick = () => {
                    tokenModal.classList.add('hidden');
                    tokenModal.classList.remove('flex');
                    resolve(false);
                };
            });
        }

        function saveToken() {
            const token = tokenInput.value.trim();
            if (token) {
                githubToken = token;
                localStorage.setItem(TOKEN_KEY, token);
                tokenModal.classList.add('hidden');
                tokenModal.classList.remove('flex');
                connectionRetries = 0; // Reset retry counter
                loadDataFromGithub();
            }
        }

        function resetToken() {
            if (confirm('Apakah Anda yakin ingin menghapus token yang tersimpan?')) {
                localStorage.removeItem(TOKEN_KEY);
                githubToken = null;
                tokenInput.value = '';
                showNotification('Token berhasil direset', 'success');
            }
        }

        async function loadDataFromGithub() {
            showLoading(true);
            try {
                const data = await fetchDataFromGithub();
                if (data) {
                    tasks = data.tasks || [];
                    tabs = data.tabs || tabs;
                    dataLoaded = true;
                    connectionRetries = 0; // Reset retry counter on success
                    renderTabs();
                    renderTasks();
                    updateCategoryLabel();
                } else {
                    // If connection fails and we have retries left, show token modal again
                    if (connectionRetries < MAX_RETRIES) {
                        connectionRetries++;
                        showError(`Gagal terhubung ke GitHub. Percobaan ${connectionRetries}/${MAX_RETRIES}. Silakan periksa token Anda.`);
                        setTimeout(() => {
                            tokenModal.classList.remove('hidden');
                            tokenModal.classList.add('flex');
                        }, 2000);
                    } else {
                        showError("Koneksi ke GitHub gagal setelah beberapa percobaan. Silakan periksa token Anda dan coba lagi.");
                    }
                }
            } catch (error) {
                console.error('Error loading data from GitHub:', error);
                showError("Terjadi kesalahan saat memuat data: " + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function fetchDataFromGithub() {
            if (!githubToken) return null;
            try {
                const response = await fetch(GITHUB_API_URL, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        showError("Token GitHub tidak valid. Silakan periksa token Anda.");
                        return null;
                    }
                    throw new Error(`GitHub API error: ${response.status}`);
                }

                const data = await response.json();
                const content = atob(data.content);
                return JSON.parse(content);
            } catch (error) {
                console.error('Error fetching data from GitHub:', error);
                return null;
            }
        }

        async function saveDataToGithub() {
            if (!githubToken) return false;

            try {
                // Get current file info first
                const currentData = await fetch(GITHUB_API_URL, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                let sha = '';
                if (currentData.ok) {
                    const currentFile = await currentData.json();
                    sha = currentFile.sha;
                }

                const dataToSave = {
                    tasks: tasks,
                    tabs: tabs
                };

                const content = btoa(JSON.stringify(dataToSave, null, 2));
                const message = sha ? 'Update agenda data' : 'Create agenda data';

                const response = await fetch(GITHUB_API_URL, {
                    method: sha ? 'PUT' : 'POST',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        content: content,
                        sha: sha || undefined
                    })
                });

                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }

                return true;
            } catch (error) {
                console.error('Error saving data to GitHub:', error);
                return false;
            }
        }

        function showLoading(show) {
            if (show) {
                loadingIndicator.classList.remove('hidden');
                loadingIndicator.classList.add('flex');
            } else {
                loadingIndicator.classList.add('hidden');
                loadingIndicator.classList.remove('flex');
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorModal.classList.remove('hidden');
            errorModal.classList.add('flex');
        }

        // Tab Management
        function renderTabs() {
            tabContainer.innerHTML = tabs.map(tab => `
                <div class="tab-item tab-item ${currentTab === tab.id ? 'tab-active' : ''} px-4 py-3 rounded-lg text-gray-700 font-medium flex items-center space-x-2 whitespace-nowrap" data-tab="${tab.id}">
                    <i class="fas ${tab.icon} text-green-600"></i>
                    <span>${tab.name}</span>
                    <div class="tab-actions ml-2">
                        ${tab.id !== 'all' ? `
                            <button class="edit-tab-btn text-gray-400 hover:text-yellow-500 ml-2 icon-btn" data-id="${tab.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-tab-btn text-gray-400 hover:text-red-500 ml-2 icon-btn" data-id="${tab.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');

            // Add event listeners to tabs
            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    if (!e.target.closest('.tab-actions')) {
                        currentTab = tab.dataset.tab;
                        renderTabs();
                        renderTasks();
                        updateCategoryLabel();
                    }
                });
            });

            // Add event listeners to tab actions
            document.querySelectorAll('.edit-tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    editTab(btn.dataset.id);
                });
            });

            document.querySelectorAll('.delete-tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteTab(btn.dataset.id);
                });
            });
        }

        function openTabModal(tabId = null) {
            editingTabId = tabId;
            const modalTitle = document.querySelector('#tabModal h2');

            if (tabId) {
                const tab = tabs.find(t => t.id === tabId);
                modalTitle.textContent = 'Edit Kategori';
                document.getElementById('tabName').value = tab.name;
                document.getElementById('tabIcon').value = tab.icon;

                // Find and select the correct icon option
                document.querySelectorAll('.icon-option').forEach(b => b.classList.remove('bg-green-100'));
                const iconOption = document.querySelector(`.icon-option[data-icon="${tab.icon}"]`);
                if (iconOption) {
                    iconOption.classList.add('bg-green-100');
                }
            } else {
                modalTitle.textContent = 'Tambah Kategori Baru';
                tabForm.reset();
                document.querySelectorAll('.icon-option').forEach(b => b.classList.remove('bg-green-100'));
                const defaultIcon = document.querySelector('[data-icon="fa-tasks"]');
                if (defaultIcon) {
                    defaultIcon.classList.add('bg-green-100');
                }
            }

            tabModal.classList.remove('hidden');
        }

        function closeTabModalHandler() {
            tabModal.classList.add('hidden');
            editingTabId = null;
            document.querySelectorAll('.icon-option').forEach(b => b.classList.remove('bg-green-100'));
        }

        async function handleTabSubmit(e) {
            e.preventDefault();

            const tabName = document.getElementById('tabName').value.trim();
            const tabIcon = document.getElementById('tabIcon').value;

            if (tabName) {
                if (editingTabId) {
                    // Update existing tab
                    const tab = tabs.find(t => t.id === editingTabId);
                    tab.name = tabName;
                    tab.icon = tabIcon;
                } else {
                    // Add new tab
                    const newTab = {
                        id: 'tab_' + Date.now(),
                        name: tabName,
                        icon: tabIcon
                    };
                    tabs.push(newTab);
                }

                const success = await saveDataToGithub();
                if (success) {
                    renderTabs();
                    closeTabModalHandler();
                    showNotification('Kategori berhasil disimpan!', 'success');
                } else {
                    showError('Gagal menyimpan kategori ke GitHub. Silakan coba lagi.');
                }
            }
        }

        function editTab(tabId) {
            openTabModal(tabId);
        }

        async function deleteTab(tabId) {
            if (confirm('Apakah Anda yakin ingin menghapus kategori ini?')) {
                tabs = tabs.filter(t => t.id !== tabId);
                // Move tasks to 'all' category
                tasks.forEach(task => {
                    if (task.category === tabId) {
                        task.category = 'all';
                    }
                });

                if (currentTab === tabId) {
                    currentTab = 'all';
                }

                const success = await saveDataToGithub();
                if (success) {
                    renderTabs();
                    renderTasks();
                    showNotification('Kategori berhasil dihapus!', 'success');
                } else {
                    showError('Gagal menghapus kategori dari GitHub. Silakan coba lagi.');
                }
            }
        }

        // Task Management
        function openTaskModal(taskId = null) {
            if (taskId) {
                // Editing existing task
                const task = tasks.find(t => t.id == taskId);
                modalTitle.textContent = 'Edit Tugas';
                editingTaskId = taskId;
                categoryLabel.textContent = tabs.find(t => t.id === task.category)?.name || 'Lainnya';
                categoryLabel.classList.remove('hidden');
            } else {
                // Adding new task
                modalTitle.textContent = 'Tambah Tugas Baru';
                taskForm.reset();
                editingTaskId = null;

                // Show category label based on current tab
                if (currentTab !== 'all') {
                    const tab = tabs.find(t => t.id === currentTab);
                    categoryLabel.textContent = tab ? tab.name : 'Lainnya';
                    categoryLabel.classList.remove('hidden');
                } else {
                    categoryLabel.classList.add('hidden');
                }
            }

            taskModal.classList.remove('hidden');

            // Initialize Quill editor if not already initialized
            setTimeout(() => {
                if (!quill) {
                    quill = new Quill('#editor-container', {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                                ['bold', 'italic', 'underline', 'strike'],
                                [{ 'color': [] }, { 'background': [] }],
                                [{ 'align': [] }],
                                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                                ['link', 'image'],
                                ['clean']
                            ]
                        },
                        placeholder: 'Masukkan judul tugas...'
                    });

                    // Update hidden input when content changes
                    quill.on('text-change', function () {
                        document.getElementById('taskTitle').value = quill.root.innerHTML;
                    });
                }

                // Set content if editing
                if (taskId) {
                    const task = tasks.find(t => t.id == taskId);
                    if (task && task.title) {
                        // Check if content is plain text or HTML
                        if (task.title.includes('<')) {
                            quill.root.innerHTML = task.title;
                        } else {
                            quill.setText(task.title);
                        }
                    } else {
                        quill.setText('');
                    }
                } else {
                    quill.setText('');
                }

                // Focus the editor
                quill.focus();
            }, 100);
        }

        function closeTaskModal() {
            taskModal.classList.add('hidden');
            taskForm.reset();
            editingTaskId = null;
            categoryLabel.classList.add('hidden');

            // Clear Quill editor
            if (quill) {
                quill.setText('');
            }
        }

        async function handleTaskSubmit(e) {
            e.preventDefault();

            // Get content from Quill editor
            const taskData = {
                title: document.getElementById('taskTitle').value,
                category: currentTab === 'all' ? 'work' : currentTab,
                priority: document.querySelector('input[name="priority"]:checked').value,
                completed: false,
                createdAt: new Date().toISOString()
            };

            if (taskData.title) {
                if (editingTaskId) {
                    // Update existing task
                    const index = tasks.findIndex(t => t.id == editingTaskId);
                    tasks[index] = { ...tasks[index], ...taskData };
                } else {
                    // Add new task
                    taskData.id = Date.now();
                    tasks.unshift(taskData);
                }

                const success = await saveDataToGithub();
                if (success) {
                    renderTasks();
                    closeTaskModal();
                    showNotification(editingTaskId ? 'Tugas berhasil diperbarui!' : 'Tugas berhasil ditambahkan!', 'success');
                } else {
                    showError('Gagal menyimpan tugas ke GitHub. Silakan coba lagi.');
                }
            }
        }

        async function toggleTask(id) {
            const task = tasks.find(t => t.id == id);
            if (task) {
                task.completed = !task.completed;
                const success = await saveDataToGithub();
                if (success) {
                    renderTasks();
                } else {
                    showError('Gagal memperbarui status tugas ke GitHub. Silakan coba lagi.');
                }
            }
        }

        async function deleteTask(id) {
            if (confirm('Apakah Anda yakin ingin menghapus tugas ini?')) {
                tasks = tasks.filter(t => t.id != id);
                const success = await saveDataToGithub();
                if (success) {
                    renderTasks();
                    showNotification('Tugas berhasil dihapus!', 'success');
                } else {
                    showError('Gagal menghapus tugas dari GitHub. Silakan coba lagi.');
                }
            }
        }

        // Toggle Completed Tasks
        function toggleCompleted() {
            showCompleted = !showCompleted;
            const icon = toggleCompletedBtn.querySelector('i');

            if (showCompleted) {
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
                toggleCompletedBtn.innerHTML = '<i class="fas fa-eye mr-2"></i>';
            } else {
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
                toggleCompletedBtn.innerHTML = '<i class="fas fa-eye-slash mr-2"></i>';
            }

            renderTasks();
        }

        // Update category label
        function updateCategoryLabel() {
            if (currentTab !== 'all') {
                const tab = tabs.find(t => t.id === currentTab);
                categoryLabel.textContent = tab ? tab.name : 'Lainnya';
                categoryLabel.classList.remove('hidden');
            } else {
                categoryLabel.classList.add('hidden');
            }
        }

        // Render Tasks
        function renderTasks() {
            let filteredTasks = tasks;

            // Filter by tab
            if (currentTab !== 'all') {
                filteredTasks = tasks.filter(task => task.category === currentTab);
            }

            // Filter by completion status
            if (!showCompleted) {
                filteredTasks = filteredTasks.filter(task => !task.completed);
            }

            if (filteredTasks.length === 0) {
                taskList.innerHTML = '';
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                taskList.innerHTML = filteredTasks.map(task => createTaskHTML(task)).join('');

                // Add event listeners
                document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        toggleTask(e.target.dataset.id);
                    });
                });

                document.querySelectorAll('.edit-task-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const taskId = btn.dataset.id;
                        openTaskModal(taskId);
                    });
                });

                document.querySelectorAll('.delete-task-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        deleteTask(btn.dataset.id);
                    });
                });

                // Add event listeners for expand/collapse buttons
                document.querySelectorAll('.expand-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const taskId = btn.dataset.id;
                        const content = document.querySelector(`.task-content[data-id="${taskId}"]`);
                        content.classList.toggle('collapsed');
                        btn.classList.toggle('expanded');
                        btn.innerHTML = content.classList.contains('collapsed')
                            ? 'Lihat Selengkapnya <i class="fas fa-chevron-down"></i>'
                            : 'Lihat Lebih Sedikit <i class="fas fa-chevron-up"></i>';
                    });
                });
            }
        }

        // Create Task HTML
        function createTaskHTML(task) {
            const priorityClass = `priority-${task.priority}`;
            const completedClass = task.completed ? 'completed' : '';
            const tab = tabs.find(t => t.id === task.category);
            const tabIcon = tab ? tab.icon : 'fa-tasks';
            const tabName = tab ? tab.name : 'Lainnya';
            const badgeClass = task.priority === 'high' ? 'badge-red' :
                task.priority === 'medium' ? 'badge-yellow' : 'badge-green';

            // Check if content is long (more than 3 lines)
            const isLongContent = task.title.split('\n').length > 3 || task.title.length > 150;

            return `
                <div class="task-card bg-white rounded-xl shadow-md p-5 ${priorityClass} ${completedClass} fade-in">
                    <div class="flex items-start justify-between">
                        <div class="flex items-start space-x-4 flex-1">
                            <input type="checkbox" class="task-checkbox w-5 h-5 text-green-600 rounded focus:ring-green-500 mt-1" data-id="${task.id}" ${task.completed ? 'checked' : ''}>
                            <div class="flex-1">
                                <div class="task-content ${isLongContent ? 'collapsed' : ''}" data-id="${task.id}">${task.title}</div>
                                ${isLongContent ? `<div class="expand-btn" data-id="${task.id}">Lihat Selengkapnya <i class="fas fa-chevron-down"></i></div>` : ''}
                                <div class="flex items-center space-x-3 mt-3">
                                    <span class="text-sm px-3 py-1 bg-green-100 text-green-700 rounded-full flex items-center">
                                        <i class="fas ${tabIcon} mr-2"></i>${tabName}
                                    </span>
                                    <span class="text-sm text-gray-500">
                                        ${new Date(task.createdAt).toLocaleDateString('id-ID')}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3 ml-4">
                            <span class="text-xs font-medium px-3 py-1 rounded-full ${badgeClass}">
                                ${getPriorityText(task.priority)}
                            </span>
                            <button class="edit-task-btn text-blue-500 hover:text-blue-700 icon-btn" data-id="${task.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-task-btn text-red-500 hover:text-red-700 icon-btn" data-id="${task.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper Functions
        function getPriorityText(priority) {
            switch (priority) {
                case 'high': return 'Tinggi';
                case 'medium': return 'Sedang';
                case 'low': return 'Rendah';
                default: return 'Tidak Ada';
            }
        }

        // Export to PDF
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(20);
            doc.text('Daftar Tugas Agenda Digital', 20, 20);

            doc.setFontSize(10);
            doc.text(`Dicetak pada: ${new Date().toLocaleDateString('id-ID')} ${new Date().toLocaleTimeString('id-ID')}`, 20, 30);

            let yPosition = 50;
            tasks.forEach((task, index) => {
                const tab = tabs.find(t => t.id === task.category);
                const tabName = tab ? tab.name : 'Lainnya';
                const tabIcon = tab ? tab.icon : 'fa-tasks';

                // Create a temporary div to render HTML content
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = task.title;
                const plainText = tempDiv.textContent || tempDiv.innerText || '';

                // Split long text into lines
                const lines = doc.splitTextToSize(`${index + 1}. ${plainText} [${tabName}] - ${getPriorityText(task.priority)}`, 170);

                // Add each line
                lines.forEach(line => {
                    if (yPosition > 270) { // If we're near the bottom of the page
                        doc.addPage();
                        yPosition = 20;
                    }
                    doc.text(line, 20, yPosition);
                    yPosition += 7;
                });

                yPosition += 3; // Add space between tasks
            });

            doc.save('agenda-tugas.pdf');
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white fade-in z-50 ${type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                    'bg-blue-500'
                }`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' :
                    type === 'error' ? 'fa-exclamation-circle' :
                        'fa-info-circle'
                } mr-2"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(notification);

            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Load GitHub token and data
            loadGithubToken().then(hasToken => {
                if (hasToken) {
                    loadDataFromGithub();
                } else {
                    showError("Token GitHub diperlukan untuk menggunakan aplikasi ini. Silakan masukkan token Anda.");
                }
            });
        });
    </script>
</body>

</html>
